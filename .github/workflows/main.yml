name: CI/CD Pipeline

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean install -DskipTests

      - name: Run Tests
        run: mvn test

  docker-build-push:
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tag and repo
        run: |
          echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV
          if [ "${{ github.ref }}" = "refs/heads/master" ]; then
            echo "IMAGE_TAG=latest" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=develop" >> $GITHUB_ENV
          fi

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.backend
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}/backend:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.REPO_LOWER }}/backend:${{ github.sha }}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}/frontend:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.REPO_LOWER }}/frontend:${{ github.sha }}

      - name: Build and push Landing image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.landing
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}/landing:latest
            ghcr.io/${{ env.REPO_LOWER }}/landing:${{ github.sha }}

  deploy-bree:
    needs: docker-build-push
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')
    runs-on: [ self-hosted, sbgb, bree ]
    steps:
      - uses: actions/checkout@v4

      - name: Set Helm parameters
        run: |
          if [ "${{ github.ref }}" = "refs/heads/master" ]; then
            echo "HELM_RELEASE=sbgb-prod" >> $GITHUB_ENV
            echo "HELM_NAMESPACE=sbgb-prod" >> $GITHUB_ENV
            echo "HELM_VALUES=k8s/helm/sbgb/values-prod.yaml" >> $GITHUB_ENV
          else
            echo "HELM_RELEASE=sbgb-dev" >> $GITHUB_ENV
            echo "HELM_NAMESPACE=sbgb-dev" >> $GITHUB_ENV
            echo "HELM_VALUES=k8s/helm/sbgb/values-dev.yaml" >> $GITHUB_ENV
          fi

      - name: Apply infrastructure (PostgreSQL)
        run: microk8s kubectl apply -f k8s/infra/postgres-shared.yaml

      - name: Deploy landing page
        run: microk8s kubectl apply -f k8s/landing/landing.yaml

      - name: Propagate TLS secret to target namespace
        run: |
          if ! microk8s kubectl get secret sbgb-tls-secret -n ${{ env.HELM_NAMESPACE }} &>/dev/null; then
            microk8s kubectl get secret sbgb-tls-secret -n sbgb-landing -o json \
              | jq 'del(.metadata.namespace,.metadata.resourceVersion,.metadata.uid,.metadata.creationTimestamp)' \
              | microk8s kubectl apply -n ${{ env.HELM_NAMESPACE }} -f -
          fi

      - name: Deploy with Helm
        run: |
          microk8s helm3 upgrade --install ${{ env.HELM_RELEASE }} ./k8s/helm/sbgb \
            --namespace ${{ env.HELM_NAMESPACE }} \
            --create-namespace \
            -f ${{ env.HELM_VALUES }} \
            --wait --timeout=5m

  deploy-pi8:
    needs: docker-build-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: [ self-hosted, sbgb, pi8 ]
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Docker Compose (prod only)
        run: |
          export GITHUB_REPOSITORY_LOWER=${GITHUB_REPOSITORY,,}
          docker compose -f docker-compose.prod.yml pull
          docker compose -f docker-compose.prod.yml up -d --remove-orphans
